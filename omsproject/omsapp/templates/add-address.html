{% load static %}
<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script defer src="{% static 'js/appscript.js' %}"></script>

<!-- <section class="p-6 sm:p-8 bg-white rounded-2xl shadow-lg max-w-5xl mx-auto mt-10"> -->
  <h2 class="text-3xl font-bold text-green-700 mb-8 text-center">Add New Address</h2>

  <form id="addressForm" class="addressForm space-y-8" method="post" action="{% url 'add-address' %}">
    {% csrf_token %}

    <!-- Address Type -->
    <div>
      <label for="selectAddress" class="block text-sm font-medium text-gray-700 mb-2">Address Type</label>
      <select id="selectAddress" name="selectAddress"
              class="w-full bg-gray-50 border border-gray-300 text-gray-700 rounded-lg px-4 py-2 focus:ring-green-600 focus:border-green-600">
        <option value="bill">Billing Address</option>
        <option value="ship">Shipping Address</option>
        {% if user_type == '1' %}
          {% if add_address_from == 'userform' %}
            <option value="serv">Serving Address</option>
            <option value="both">All</option>
          {% else %}
            <option value="both">Both</option>
          {% endif %}
        {% else %}
          <option value="both">Both</option>
        {% endif %}
      </select>
    </div>

    <!-- Address Fields -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <label for="pinCode" class="block text-sm font-medium text-gray-700 mb-2">PIN Code</label>
        <input type="number" id="pinCode" name="pinCode" placeholder="Enter PIN"
               class="pinCode w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2 focus:ring-green-600 focus:border-green-600" />
      </div>

      <div>
        <label for="userState" class="block text-sm font-medium text-gray-700 mb-2">State</label>
        <select id="userState" name="userState"
                class="userState w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2 focus:ring-green-600 focus:border-green-600">
          {% for state in states %}
            <option value="{{ state.0 }}">{{ state.1 }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label for="userDistrict" class="block text-sm font-medium text-gray-700 mb-2">District</label>
        <select id="userDistrict" name="userDistrict"
                class="userDistrict w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2 focus:ring-green-600 focus:border-green-600">
          <option value="">Select District</option>
        </select>
      </div>

      <div>
        <label for="userCity" class="block text-sm font-medium text-gray-700 mb-2">Block / Sub-District</label>
        <select id="userCity" name="userCity"
                class="userCity w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2 focus:ring-green-600 focus:border-green-600">
          <option value="">Select Block/Sub-District</option>
        </select>
      </div>

      <div class="md:col-span-2">
        <label for="userAddress" class="block text-sm font-medium text-gray-700 mb-2">Full Address</label>
        <input type="text" id="userAddress" name="userAddress" placeholder="Full Address"
               class="userAddress w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2 focus:ring-green-600 focus:border-green-600" />
      </div>

      <div>
        <label for="contactPerson" class="block text-sm font-medium text-gray-700 mb-2">Contact Person</label>
        <input type="text" id="contactPerson" name="contactPerson" placeholder="Name"
               class="contactPerson w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2 focus:ring-green-600 focus:border-green-600" />
      </div>

      <div>
        <label for="contactNo" class="block text-sm font-medium text-gray-700 mb-2">Contact Number</label>
        <input type="text" id="contactNo" name="contactNo" placeholder="Mobile Number"
               class="contactNo w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2 focus:ring-green-600 focus:border-green-600" />
      </div>
    </div>

    <!-- Buttons -->
    <div class="flex justify-end gap-4 mt-6">
      <button type="button"
              class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300"
              onclick="closeModal('modalAddAddress')">Cancel</button>
      <button type="submit"
              class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 shadow-sm">Add Address</button>
    </div>
  </form>
<!-- </section> -->


  <script>
    document.querySelectorAll(".pinCode").forEach(function (input) {
      input.addEventListener("blur", function (event) {
          const form = event.target.closest(".addressForm");
          if (form) {
              // Now 'form' refers to the specific form this input is in
              const pincode = event.target.value;
              // You can now call:
              const form = event.target.closest(".addressForm");
              //var pincode = document.getElementById('pinCode').value;
              var postal_api = "https://api.postalpincode.in/pincode/"+pincode;
              fetch(postal_api)
              .then(response => response.json())
              .then(data => {
                  const select_userstate = form.querySelector('.userState');//document.getElementById("userState");

                  var postal_data = data;
                  if (postal_data[0]['Status'] == "Error"){
                      alert('Pin Code not found!');
                      return;
                  }
                  else{
                      var state = postal_data[0]['PostOffice'][0]['Circle'];
                      for (let i = 0; i < select_userstate.options.length; i++) {
                          if (select_userstate.options[i].text === state) {
                              select_userstate.selectedIndex = i;
                              break;
                          }
                      }
                  }

                  var statecode = form.querySelector('.userState').value;
                  var district = postal_data[0]['PostOffice'][0]['District'];
                  var sub_district = postal_data[0]['PostOffice'][0]['Block'];

                  fetch_lgd_district(statecode, district, sub_district,form);
              })
              .catch(error => {
                  console.log(error);
              })
          }
      });
  });

  document.querySelectorAll(".userState").forEach(function (input){
    input.addEventListener("change", function(event){
      const selectedValue = event.target.value;
      const form = event.target.closest(".addressForm");
      if(form){
        var statecode = form.querySelector('.userState').value
        fetch_lgd_district_onchange(statecode);
      }
    });
  });

  function fetch_lgd_district_onchange(statecode){
    const form = event.target.closest(".addressForm");
    const userDistrict = form.querySelector('.userDistrict');
    const userCity = form.querySelector(".userCity");
    // Clear the select and then load
    userDistrict.options.length = 0;
    userCity.options.length = 0;

    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.text = 'Select District';
    userDistrict.appendChild(defaultOption);

    const api = `https://api.data.gov.in/resource/37231365-78ba-44d5-ac22-3deec40b9197?api-key=579b464db66ec23bdd0000011c8e390297d348f14342ed5a091d6a99&format=json&limit=1000&filters%5Bstate_code%5D=${statecode}`;
    
    fetch(api)
      .then(response => response.json())
      .then(data => {
          if(data.status === "error"){
              alert('Error in fetching data from API! Code:001');
          }
          
          if (Array.isArray(data.records)) {
              data.records.sort((a, b) => a.district_name_english.localeCompare(b.district_name_english));
              for (const record of data.records) {
                  const option = document.createElement('option');
                  option.value = record.district_code;
                  option.text = record.district_name_english;
                  userDistrict.appendChild(option);
              }
            } else {
                console.error("Expected 'records' to be an array.");
            }
      })
      .catch(error => {
          console.error('Error fetching district data:', error);
      });
                
  }

  document.querySelectorAll(".userDistrict").forEach(function (input){
    input.addEventListener("change", function(event){
      const selectedValue = event.target.value;
      const form = event.target.closest(".addressForm");
      if(form){
        var statecode = form.querySelector('.userState').value;
        var districtcode = form.querySelector('.userDistrict').value;
        fetch_lgd_subdistrict_onchange(statecode, districtcode);
      }
    });
  });

  function fetch_lgd_subdistrict_onchange(statecode,districtcode){
    const form = event.target.closest(".addressForm");
    const userCity = form.querySelector(".userCity");
    // Clear existing options
    userCity.options.length = 0;

    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.text = 'Select Block/Sub-District';
    userCity.appendChild(defaultOption);

    const api = `https://api.data.gov.in/resource/6be51a29-876a-403a-a6da-42fde795e751?api-key=579b464db66ec23bdd0000011c8e390297d348f14342ed5a091d6a99&format=json&limit=1000&filters%5Bstate_code%5D=${statecode}&filters%5Bdistrict_code%5D=${districtcode}`;

    fetch(api)
        .then(response => response.json())
        .then(data => {
            data.records.sort((a, b) => a.subdistrict_name_english.localeCompare(b.subdistrict_name_english));

            if (Array.isArray(data.records)) {
                for (const record of data.records) {
                    const option = document.createElement('option');
                    option.value = record.subdistrict_code;
                    option.text = record.subdistrict_name_english;
                    userCity.appendChild(option);
                }
            } else {
                console.error("Expected 'records' to be an array.");
            }
        })
        .catch(error => {
            console.error("Error fetching subdistrict data:", error);
        });
  }

  function fetch_lgd_district(statecode, district, sub_district, form) {
    const userDistrict = form.querySelector('.userDistrict');
    // Clear the select and then load
        userDistrict.options.length = 0;

        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.text = 'Select District';
        userDistrict.appendChild(defaultOption);

        const api = `https://api.data.gov.in/resource/37231365-78ba-44d5-ac22-3deec40b9197?api-key=579b464db66ec23bdd0000011c8e390297d348f14342ed5a091d6a99&format=json&limit=1000&filters%5Bstate_code%5D=${statecode}`;
        
        fetch(api)
            .then(response => response.json())
            .then(data => {
                if(data.status === "error"){
                    alert('Error in fetching data from API! Code:001');
                }
                
                if (Array.isArray(data.records)) {
                    data.records.sort((a, b) => a.district_name_english.localeCompare(b.district_name_english));
                    console.log(statecode);
                    for (const record of data.records) {
                        const option = document.createElement('option');
                        option.value = record.district_code;
                        option.text = record.district_name_english;
                        userDistrict.appendChild(option);
                    }
                    
                    if(!isNaN(district)){
                        userDistrict.value = district;
                    }
                    else{
                        let arr_districts = [];
                        for (let i = 0; i < userDistrict.options.length; i++) {
                            arr_districts.push(userDistrict.options[i].text);
                        }
                        
                        const matchedDistrict = fuzzySearch(district, arr_districts);
                        for (let i = 0; i < userDistrict.options.length; i++) {
                            if (userDistrict.options[i].text === matchedDistrict[0]) {
                                userDistrict.selectedIndex = i;
                                break;
                            }
                        }
                    }

                    const selectedStateCode = form.querySelector('.userState')?.value;
                    const selectedDistrictCode = userDistrict.value;

                    fetch_lgd_subdistrict(selectedStateCode, selectedDistrictCode, sub_district, form);
                } else {
                    console.error("Expected 'records' to be an array.");
                }
            })
            .catch(error => {
                console.error('Error fetching district data:', error);
            });
  }

  function fetch_lgd_subdistrict(statecode, districtcode, sub_district, form){
    const userCity = form.querySelector(".userCity");
    // Clear existing options
        userCity.options.length = 0;

        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.text = 'Select Block/Sub-District';
        userCity.appendChild(defaultOption);

        const api = `https://api.data.gov.in/resource/6be51a29-876a-403a-a6da-42fde795e751?api-key=579b464db66ec23bdd0000011c8e390297d348f14342ed5a091d6a99&format=json&limit=1000&filters%5Bstate_code%5D=${statecode}&filters%5Bdistrict_code%5D=${districtcode}`;

        fetch(api)
            .then(response => response.json())
            .then(data => {
                data.records.sort((a, b) => a.subdistrict_name_english.localeCompare(b.subdistrict_name_english));

                if (Array.isArray(data.records)) {
                    for (const record of data.records) {
                        const option = document.createElement('option');
                        option.value = record.subdistrict_code;
                        option.text = record.subdistrict_name_english;
                        userCity.appendChild(option);
                    }

                    if(!isNaN(sub_district)){
                        userCity.value = sub_district;
                    }
                    else{
                        const arr_subdistricts = [];
                        for (let i = 0; i < userCity.options.length; i++) {
                            arr_subdistricts.push(userCity.options[i].text);
                        }

                        const matchedSubdistrict = fuzzySearch(sub_district, arr_subdistricts);
                        for (let i = 0; i < userCity.options.length; i++) {
                            if (userCity.options[i].text === matchedSubdistrict[0]) {
                                userCity.selectedIndex = i;
                                break;
                            }
                        }
                    }
                } else {
                    console.error("Expected 'records' to be an array.");
                }
            })
            .catch(error => {
                console.error("Error fetching subdistrict data:", error);
            });
  }

  function levenshteinDistance(a, b) {
    const matrix = Array.from({ length: b.length + 1 }, (_, i) => [i]);

    for (let j = 0; j <= a.length; j++) {
      matrix[0][j] = j;
    }

    for (let i = 1; i <= b.length; i++) {
      for (let j = 1; j <= a.length; j++) {
        const cost = b[i - 1] === a[j - 1] ? 0 : 1;
        matrix[i][j] = Math.min(
          matrix[i - 1][j] + 1,     // Deletion
          matrix[i][j - 1] + 1,     // Insertion
          matrix[i - 1][j - 1] + cost // Substitution
        );
      }
    }

    return matrix[b.length][a.length];
  }

  function fuzzySearch(query, items, threshold = 70) {
    query = query.toLowerCase();
    const results = [];

    for (const item of items) {
      const itemLower = item.toLowerCase();
      const distance = levenshteinDistance(query, itemLower);
      const maxLen = Math.max(query.length, itemLower.length);
      const similarity = ((maxLen - distance) / maxLen) * 100;

      if (similarity >= threshold) {
        results.push(item);
      }
    }

    if (results.length === 0 && threshold > 50) {
      return fuzzySearch(query, items, 50); // recursive fallback
    }

    return results;
  }
   
    document.getElementById("addressForm").addEventListener("submit", function(event) {      
      const form = input;
      const inputs = form.querySelectorAll("input, select");
      let isValid = true;
      inputs.forEach((field) => {
        if (field.value.trim() === "") {
          isValid = false;
          field.style.border = "2px solid red"; // Optional visual cue
        } else {
          field.style.border = ""; // Reset style
        }
      });
      if (!isValid) {
        event.preventDefault();
        alert("Please fill in all required fields.");
      } else {
        form.submit(); // All fields are valid — submit the form
      }
    });
  </script>