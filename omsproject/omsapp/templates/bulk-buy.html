{% extends 'index.html' %}
{% load static %}
{% block bulk_buy %}
  <div class="max-w-7xl mx-auto px-4 py-10">
    <h1 class="text-3xl font-bold text-green-700 mb-8">Bulk Buy Request</h1>

    <form id="formBulkBuy" onsubmit="return false;" class="bg-white p-6 rounded shadow space-y-6">
      {% csrf_token %}

      <!-- Form Grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Left Column -->
        <div class="space-y-4">
          <div>
            <label for="name" class="block text-sm font-medium text-gray-700">Name</label>
            <input type="text" id="name" name="name" value="{{login_user}}" disabled
                  class="mt-1 block w-full h-10 rounded border-gray-300 shadow-sm focus:ring-green-600 focus:border-green-600">
          </div>

          <div>
            <label for="address1" class="block text-sm font-medium text-gray-700">Billing Address</label>
            <input type="text" id="address1" name="address1" value="{{user_address1}}" placeholder="Address1"
                  class="mt-1 block w-full h-10 rounded border-gray-300 shadow-sm focus:ring-green-600 focus:border-green-600">
          </div>

          <div>
            <label for="delivery-date" class="block text-sm font-medium text-gray-700">Select Delivery Date</label>
            <input type="date" id="delivery-date" name="delivery_date"
                  class="mt-1 block w-full h-10 rounded border-gray-300 shadow-sm focus:ring-green-600 focus:border-green-600">
          </div>
        </div>

        <!-- Right Column -->
        <div class="space-y-4">
          <div>
            <label for="type" class="block text-sm font-medium text-gray-700">Type</label>
            <input type="text" id="type" name="type" value="{{userType}}" disabled
                  class="mt-1 block w-full h-10 rounded border-gray-300 shadow-sm focus:ring-green-600 focus:border-green-600">
          </div>

          <div>
            <label for="address2" class="block text-sm font-medium text-gray-700">Select Frequency</label>
            <select name="order_frequency" id="order_frequency" class="mt-1 block w-full h-10 rounded border-gray-300 shadow-sm focus:ring-green-600 focus:border-green-600">
              <option>Once</option>
              <option>Daily</option>
              <option>Weekly</option>
              <option>Fortnightly</option>
              <option>Monthly</option>
              <option>Quarterly</option>
            </select>
            <!-- <input type="hidden" id="address2" name="address2" value="{{user_address1}}" placeholder="Address2"
                  class="mt-1 block w-full h-10 rounded border-gray-300 shadow-sm focus:ring-green-600 focus:border-green-600"> -->
          </div>

          <div>
            <label for="phone" class="block text-sm font-medium text-gray-700">Phone</label>
            <input type="text" id="phone" name="phone" value="{{user_phone}}" placeholder="Phone"
                  class="mt-1 block w-full h-10 rounded border-gray-300 shadow-sm focus:ring-green-600 focus:border-green-600">
          </div>
        </div>
      </div>

      <!-- Items Table -->
      <div class="space-y-4">
        <!-- Header Row: Only visible on md+ screens -->
        <div class="hidden md:grid grid-cols-6 gap-2 bg-green-100 text-gray-700 text-sm font-semibold p-2 rounded">
            <div>Item Name</div>
            <div>Specification</div>
            <div>Qty</div>
            <div>Unit</div>
            <div>Price</div>
            <div>Action</div>
        </div>

        <!-- Input Row -->
        <div class="grid grid-cols-1 md:grid-cols-6 gap-2 bg-white p-3 border rounded shadow-sm">
            <!-- Item Name -->
            <div class="flex flex-col">
            <label class="md:hidden text-sm font-medium text-gray-600 mb-1">Item Name</label>
            <select id="selectItems" name="selectItems"
                    class="w-full h-10 rounded border-gray-300 focus:ring-green-600 focus:border-green-600">
                <option>Select Item</option>
                {% for item in items %}
                <option value="{{item.itemName}}">{{item.itemName}}</option>
                {% endfor %}
            </select>
            </div>

            <!-- Specification -->
            <div class="flex flex-col">
            <label class="md:hidden text-sm font-medium text-gray-600 mb-1">Specification</label>
            <input type="text" id="txtSpec" name="txtSpec" placeholder="Specification"
                    class="w-full h-10 rounded border-gray-300 focus:ring-green-600 focus:border-green-600" />
            </div>

            <!-- Quantity -->
            <div class="flex flex-col">
            <label class="md:hidden text-sm font-medium text-gray-600 mb-1">Quantity</label>
            <input type="text" id="txtQty" name="txtQty" placeholder="Qty"
                    class="w-full h-10 rounded border-gray-300 focus:ring-green-600 focus:border-green-600 text-center" />
            </div>

            <!-- Unit -->
            <div class="flex flex-col">
            <label class="md:hidden text-sm font-medium text-gray-600 mb-1">Unit</label>
            <select id="selectUnit" name="selectUnit"
                    class="w-full h-10 rounded border-gray-300 focus:ring-green-600 focus:border-green-600">
                <option>Select Unit</option>
                {% for item in distinct_units %}
                <option value="{{item.itemUnit}}">{{item.itemUnit}}</option>
                {% endfor %}
            </select>
            </div>

            <!-- Price -->
            <div class="flex flex-col">
            <label class="md:hidden text-sm font-medium text-gray-600 mb-1">Indicative Price</label>
            <input type="text" id="txtPrice" name="txtPrice" placeholder="Price"
                    class="w-full h-10 rounded border-gray-300 focus:ring-green-600 focus:border-green-600 text-center" />
            </div>

            <!-- Action Button -->
            <div class="flex items-end justify-center md:justify-start">
            <button type="button" onclick="addRow()"
                    class="p-2 bg-green-600 hover:bg-green-700 text-white rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="5" x2="12" y2="19" />
                <line x1="5" y1="12" x2="19" y2="12" />
                </svg>
            </button>
            </div>
        </div>

        <!-- Dynamic Items List -->
        <div id="tableBody" class="space-y-4">
            <!-- Dynamically added cards will appear here -->
        </div>
        </div>


      <!-- Submit Button -->
      <div class="text-center">
        <button type="button" onclick="sendTableToServer()"
                class="bg-green-700 hover:bg-green-800 text-white font-semibold py-2 px-6 rounded-md shadow transition">
          Submit Request
        </button>
      </div>
    </form>
  </div>
  
  <!-- Optional Script -->
  <script>
  // The date selection in the calendar
  document.addEventListener("DOMContentLoaded", function() {
    const today = new Date();
    const min_date = today.toISOString().split('T')[0];
    const futureDate = new Date(today);
    futureDate.setMonth(futureDate.getMonth() + 12);
    const max_date = futureDate.toISOString().split('T')[0];

    const dateInput = document.getElementById("delivery-date");
    dateInput.setAttribute('min', min_date);
    dateInput.setAttribute('max', max_date);
  });

  // sending the item table to the server
  function sendTableToServer() {
    let validate = true;
    const formBulkBuy = document.getElementById('formBulkBuy');
    const delivery_date = document.getElementById('delivery-date').value;
    const order_frequency = document.getElementById('order_frequency').value;
    const cardRows = document.querySelectorAll('.card-row');
    const rows = [];

    if (delivery_date === '') {
        alert('Please select delivery date!');
        validate = false;
    } else if (cardRows.length < 1) {
        alert('Please add items for bulk buy!\nAfter entering item details, click on the Add (+) icon.');
        validate = false;
    } else {
        cardRows.forEach(card => {
        const columns = card.querySelectorAll('p');
        const itemName = columns[0]?.textContent.trim() || '';
        const itemSpec = columns[1]?.textContent.trim() || '';
        const itemQty = columns[2]?.textContent.trim() || '';
        const itemUnit = columns[3]?.textContent.trim() || '';
        const itemPrice = columns[4]?.textContent.replace('â‚¹', '').trim() || '';

        rows.push({ itemName, itemSpec, itemQty, itemUnit, itemPrice });
        });

        fetch('bulk-buy/order', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ rows, delivery_date, order_frequency })
        })
        .then(response => response.json())
        .then(data => {
        alert(data.message);
        if (data.redirect_url) {
            window.location.href = data.redirect_url;
        }
        })
        .catch(error => console.error('Error:', error));
    }

    if (validate) {
        formBulkBuy.submit();
    }
  }
  
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function addRow() {
    const tableBody = document.getElementById("tableBody");

    const itemName = document.getElementById("selectItems").value;
    const spec = document.getElementById("txtSpec").value;
    const qty = document.getElementById("txtQty").value;
    const unit = document.getElementById("selectUnit").value;
    const price = document.getElementById("txtPrice").value;

    if (!itemName || !spec || !qty || !unit || !price) {
      alert("Please fill in all fields.");
      return;
    }

    // Create styled card
    const card = document.createElement("div");
    card.className = "bg-white rounded-lg shadow-md p-4 mb-3 border border-gray-200";

    // Content wrapper (grid layout)
    card.innerHTML = `
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-6 gap-4 text-sm">
        <div>
          <span class="block text-gray-500 font-medium mb-1">Item</span>
          <p class="font-semibold text-gray-800">${itemName}</p>
        </div>
        <div>
          <span class="block text-gray-500 font-medium mb-1">Specification</span>
          <p class="text-gray-700">${spec}</p>
        </div>
        <div>
          <span class="block text-gray-500 font-medium mb-1">Quantity</span>
          <p>${qty}</p>
        </div>
        <div>
          <span class="block text-gray-500 font-medium mb-1">Unit</span>
          <p>${unit}</p>
        </div>
        <div>
          <span class="block text-gray-500 font-medium mb-1">Price</span>
          <p>â‚¹${price}</p>
        </div>
        <div class="flex items-start justify-end md:justify-center pt-1">
          <button type="button" class="text-red-600 hover:text-red-800" onclick="this.closest('div.card-row').remove()">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18" />
              <line x1="6" y1="6" x2="18" y2="18" />
            </svg>
          </button>
        </div>
      </div>
    `;

    card.classList.add("card-row"); // helper class to easily remove

    tableBody.appendChild(card);

    // Reset inputs
    document.getElementById("selectItems").selectedIndex = 0;
    document.getElementById("txtSpec").value = "";
    document.getElementById("txtQty").value = "";
    document.getElementById("selectUnit").selectedIndex = 0;
    document.getElementById("txtPrice").value = "";
  }


  // remove a row
  function removeRow(button) {
    const row = button.closest('tr');
    row.remove();
  }

  
  function addressClick(){      
      var cb_sameAddress = document.getElementById('cb_sameAddress');
      if(cb_sameAddress.checked)
        {
          document.getElementById('txtBilling').value = document.getElementById('txtShipping').value;
        }
      else
        {
          document.getElementById('txtBilling').value = "";
        }
  }
  </script>

{% endblock %}